import{K as V,r as i,j as e,L as N,$ as K,S as W}from"./app-CoagF3OV.js";import{B as m}from"./button-DiwSB_ws.js";import{C as Y}from"./checkbox-CYhq3B76.js";import{I as Z}from"./input-BMF2iBSR.js";import{L as E}from"./label-Dp7V1G_b.js";import{S as D}from"./separator-D8T14aeF.js";import{U as w}from"./user-layout-Cqd01FhB.js";import{U}from"./user-CGd2m1Nj.js";import{B as ee}from"./badge-check-ChzZ6BLA.js";import{H as te}from"./hourglass-CDsJzPQr.js";import{C as O}from"./index-C9rWrU68.js";import{X as ae}from"./x--5bXEWR7.js";import"./index-BXEQ4bzJ.js";import"./index-CvEpHCJr.js";import"./utils-C9PFdcQI.js";import"./index-CMuwh_Aq.js";import"./index-CokJC4k2.js";import"./index-l9Ya2sLU.js";import"./floating-ui.react-dom-BaCIZNLQ.js";import"./index-VR4SfWyp.js";import"./index-Dodb3Zr4.js";import"./sonner-CRkHKkCx.js";import"./index-vitnN30e.js";import"./breadcrumbs-CtJ1jZuh.js";import"./createLucideIcon-CbJIzLBb.js";import"./index-DS7d39Bl.js";import"./Combination-BqWVWUy8.js";import"./tooltip-C44tGr1s.js";import"./index-DRkvNbUN.js";import"./dropdown-menu-D-NhDSvP.js";import"./circle-DWvAmx5R.js";import"./chevron-right-CedjaeBW.js";import"./mail-Da2henM3.js";import"./phone-DF0cpQHD.js";import"./icon-xgNV2pxV.js";import"./house-DZDE7rfV.js";import"./monitor-play-FrPtpanR.js";function $e({course:t,hasAccess:H,pendingInvoiceUrl:v,referralInfo:o}){var F;const{auth:S}=V().props,C=!!S.user,f=C&&((F=S.user)==null?void 0:F.phone_number),[g,$]=i.useState(!1),[_,x]=i.useState(!1),[c,B]=i.useState(""),[a,u]=i.useState(null),[P,L]=i.useState(!1),[j,d]=i.useState(""),n=t.price===0,y=5e3,I=t.price,G=(a==null?void 0:a.discount_amount)||0,A=I-G,T=n?0:A+y;i.useEffect(()=>{const r=new URLSearchParams(window.location.search).get("ref");r?sessionStorage.setItem("referral_code",r):o.code&&sessionStorage.setItem("referral_code",o.code)},[o]),i.useEffect(()=>{if(!c.trim()||n){u(null),d("");return}const s=setTimeout(()=>{q()},500);return()=>clearTimeout(s)},[c]);const q=async()=>{var s;if(!(!c.trim()||n)){L(!0),d("");try{const l=await(await fetch("/api/discount-codes/validate",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||""},credentials:"same-origin",body:JSON.stringify({code:c,amount:t.price,product_type:"course",product_id:t.id})})).json();l.valid?(u(l),d("")):(u(null),d(l.message||"Kode promo tidak valid"))}catch{u(null),d("Terjadi kesalahan saat memvalidasi kode promo")}finally{L(!1)}}},z=async()=>{try{const r=await(await fetch("/csrf-token",{method:"GET",credentials:"same-origin"})).json(),l=document.querySelector('meta[name="csrf-token"]');return l&&(l.content=r.token),r.token}catch(s){throw console.error("Failed to refresh CSRF token:",s),s}},M=s=>{if(s.preventDefault(),!f){alert("Profil Anda belum lengkap! Harap lengkapi nomor telepon terlebih dahulu."),window.location.href=route("profile.edit");return}x(!0),W.post(route("enroll.free"),{type:"course",id:t.id},{onError:r=>{console.log("Free enrollment errors:",r),alert(r.message||"Gagal mendaftar kelas gratis.")},onFinish:()=>{x(!1)}})},X=async s=>{if(s.preventDefault(),!f){alert("Profil Anda belum lengkap! Harap lengkapi nomor telepon terlebih dahulu."),window.location.href=route("profile.edit");return}if(!g&&!n){alert("Anda harus menyetujui syarat dan ketentuan!");return}if(x(!0),n)return M(s);const r=async(l=0)=>{var R;const J=t.strikethrough_price>0?t.strikethrough_price-t.price:0,Q=(a==null?void 0:a.discount_amount)||0,b={type:"course",id:t.id,discount_amount:J+Q,nett_amount:A,transaction_fee:y,total_amount:T};a!=null&&a.valid&&(b.discount_code_id=a.discount_code.id,b.discount_code_amount=a.discount_amount);try{const h=(R=document.querySelector('meta[name="csrf-token"]'))==null?void 0:R.content,k=await fetch(route("invoice.store"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":h||"",Accept:"application/json"},credentials:"same-origin",body:JSON.stringify(b)});if(k.status===419&&l<2)return console.log(`CSRF token expired, refreshing... (attempt ${l+1})`),await z(),r(l+1);const p=await k.json();if(k.ok&&p.success)if(p.payment_url)window.location.href=p.payment_url;else throw new Error("Payment URL not received");else throw new Error(p.message||"Gagal membuat invoice.")}catch(h){throw console.error("Payment error:",h),h}};try{await r()}catch(l){alert(l.message||"Terjadi kesalahan saat proses pembayaran."),x(!1)}};if(!C){const s=window.location.href,r=route("login",{redirect:s});return e.jsxs(w,{children:[e.jsx(N,{title:"Login Required"}),e.jsx("section",{className:"to-tertiary from-primary w-full bg-gradient-to-br px-4",children:e.jsxs("div",{className:"mx-auto my-12 w-full max-w-7xl px-4",children:[e.jsxs("h2",{className:"mx-auto mb-4 max-w-3xl text-center text-3xl font-bold text-white sm:text-4xl",children:['Daftar Kelas Online "',t.title,'"']}),e.jsx("img",{src:t.thumbnail?`/storage/${t.thumbnail}`:"/assets/images/placeholder.png",alt:t.title,className:"mx-auto my-6 w-full max-w-xl rounded-lg border border-gray-200 shadow-md"}),e.jsx("p",{className:"text-center text-gray-200",children:"Silakan login terlebih dahulu untuk mendaftar kelas online."})]})}),e.jsx("section",{className:"mx-auto my-4 w-full max-w-7xl px-4",children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 rounded-lg border p-6 text-center",children:[e.jsx(U,{size:64,className:"text-blue-500"}),e.jsx("h2",{className:"text-xl font-bold",children:"Login Diperlukan"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Anda perlu login terlebih dahulu untuk mendaftar kelas online ini.",o.hasActive&&" Kode referral Anda akan tetap tersimpan."]}),e.jsxs("div",{className:"flex w-full max-w-md gap-2",children:[e.jsx(m,{asChild:!0,className:"flex-1",children:e.jsx("a",{href:r,children:"Login"})}),e.jsx(m,{asChild:!0,variant:"outline",className:"flex-1",children:e.jsx(K,{href:route("register",o.code?{ref:o.code}:{}),children:"Daftar"})})]})]})})]})}return f?e.jsxs(w,{children:[e.jsx(N,{title:"Checkout Kelas"}),e.jsx("section",{className:"to-tertiary from-primary w-full bg-gradient-to-br px-4",children:e.jsxs("div",{className:"mx-auto my-12 w-full max-w-7xl px-4",children:[e.jsxs("h2",{className:"mx-auto mb-4 max-w-3xl text-center text-3xl font-bold text-white sm:text-4xl",children:['Checkout Kelas "',t.title,'"']}),e.jsx("img",{src:t.thumbnail?`/storage/${t.thumbnail}`:"/assets/images/placeholder.png",alt:t.title,className:"mx-auto my-6 w-full max-w-xl rounded-lg border border-gray-200 shadow-md"}),e.jsx("p",{className:"text-center text-gray-200",children:n?"Lanjutkan untuk mendapatkan akses gratis ke kelas ini.":"Silakan selesaikan pembayaran untuk mendaftar kelas."})]})}),e.jsx("section",{className:"mx-auto my-4 w-full max-w-7xl px-4",children:e.jsx("div",{className:"w-full",children:H?e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 rounded-lg border p-6 text-center",children:[e.jsx(ee,{size:64,className:"text-green-500"}),e.jsx("h2",{className:"text-xl font-bold",children:"Anda Sudah Memiliki Akses"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Anda sudah terdaftar di kelas ini. Silakan lanjutkan belajar."}),e.jsx(m,{asChild:!0,className:"w-full",children:e.jsx("a",{href:`/profile/my-courses/${t.slug}`,children:"Masuk ke Kelas"})})]}):v?e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 rounded-lg border p-6 text-center",children:[e.jsx(te,{size:64,className:"text-yellow-500"}),e.jsx("h2",{className:"text-xl font-bold",children:"Pembayaran Tertunda"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Anda memiliki pembayaran yang belum selesai untuk kelas ini. Silakan lanjutkan untuk membayar."}),e.jsx(m,{asChild:!0,className:"w-full",children:e.jsx("a",{href:v,children:"Lanjutkan Pembayaran"})})]}):e.jsxs("form",{onSubmit:X,children:[e.jsxs("h2",{className:"my-2 text-xl font-bold",children:["Detail ",n?"Pendaftaran":"Pembayaran"]}),e.jsxs("div",{className:"space-y-4 rounded-lg border p-4",children:[n?e.jsx("div",{className:"flex items-center justify-between p-4 text-center",children:e.jsx("span",{className:"w-full text-2xl font-bold text-green-600",children:"KELAS GRATIS"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"promo-code",children:"Kode Promo (Opsional)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Z,{id:"promo-code",type:"text",placeholder:"Masukkan kode promo",value:c,onChange:s=>B(s.target.value.toUpperCase()),className:"pr-10"}),P&&e.jsx("div",{className:"absolute top-1/2 right-3 -translate-y-1/2 transform",children:e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-b-2 border-blue-600"})}),!P&&c&&e.jsx("div",{className:"absolute top-1/2 right-3 -translate-y-1/2 transform",children:a!=null&&a.valid?e.jsx(O,{className:"h-4 w-4 text-green-600"}):j?e.jsx(ae,{className:"h-4 w-4 text-red-600"}):null})]}),j&&e.jsx("p",{className:"text-sm text-red-600",children:j}),(a==null?void 0:a.valid)&&e.jsxs("div",{className:"rounded-lg border border-green-200 bg-green-50 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4 text-green-600"}),e.jsxs("p",{className:"text-sm font-medium text-green-800",children:['Kode promo "',a.discount_code.code,'" berhasil diterapkan!']})]}),e.jsxs("p",{className:"mt-1 text-xs text-green-600",children:[a.discount_code.name," - Diskon ",a.discount_code.formatted_value]})]})]}),e.jsxs("div",{className:"space-y-2 rounded-lg border p-4",children:[t.strikethrough_price>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Harga Asli"}),e.jsxs("span",{className:"font-semibold text-gray-500 line-through",children:["Rp ",t.strikethrough_price.toLocaleString("id-ID")]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Diskon"}),e.jsxs("span",{className:"font-semibold text-red-500",children:["-Rp ",(t.strikethrough_price-t.price).toLocaleString("id-ID")]})]}),e.jsx(D,{className:"my-2"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Harga Kelas"}),e.jsxs("span",{className:"font-semibold text-gray-500",children:["Rp ",t.price.toLocaleString("id-ID")]})]}),(a==null?void 0:a.valid)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-gray-600",children:["Diskon Promo (",a.discount_code.code,")"]}),e.jsxs("span",{className:"font-semibold text-green-600",children:["-Rp ",a.discount_amount.toLocaleString("id-ID")]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Biaya Transaksi"}),e.jsxs("span",{className:"font-semibold text-gray-500",children:["Rp ",y.toLocaleString("id-ID")]})]}),e.jsx(D,{className:"my-2"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Total Pembayaran"}),e.jsxs("span",{className:"text-primary text-xl font-bold",children:["Rp ",T.toLocaleString("id-ID")]})]})]})]}),!n&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{id:"terms",checked:g,onCheckedChange:s=>$(s===!0)}),e.jsxs(E,{htmlFor:"terms",children:["Saya menyetujui"," ",e.jsx("a",{href:"/terms-and-conditions",target:"_blank",rel:"noopener noreferrer",className:"text-blue-700 hover:underline",children:"syarat dan ketentuan"})]})]}),e.jsx(m,{className:"w-full",type:"submit",disabled:(n?!1:!g)||_,children:_?"Memproses...":n?"Dapatkan Akses Gratis Sekarang":"Lanjutkan Pembayaran"})]})]})})})]}):e.jsxs(w,{children:[e.jsx(N,{title:"Checkout Kelas"}),e.jsx("section",{className:"to-tertiary from-primary w-full bg-gradient-to-br px-4",children:e.jsxs("div",{className:"mx-auto my-12 w-full max-w-7xl px-4",children:[e.jsxs("h2",{className:"mx-auto mb-4 max-w-3xl text-center text-3xl font-bold text-white sm:text-4xl",children:['Checkout Kelas "',t.title,'"']}),e.jsx("img",{src:t.thumbnail?`/storage/${t.thumbnail}`:"/assets/images/placeholder.png",alt:t.title,className:"mx-auto my-6 w-full max-w-xl rounded-lg border border-gray-200 shadow-md"}),e.jsx("p",{className:"text-center text-gray-200",children:"Silakan lengkapi profil Anda terlebih dahulu."})]})}),e.jsx("section",{className:"mx-auto my-4 w-full max-w-7xl px-4",children:e.jsxs("div",{className:"flex h-full flex-col items-center justify-center space-y-4 rounded-lg border p-6 text-center",children:[e.jsx(U,{size:64,className:"text-orange-500"}),e.jsx("h2",{className:"text-xl font-bold",children:"Profil Belum Lengkap"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Profil Anda belum lengkap! Harap lengkapi nomor telepon terlebih dahulu untuk mendaftar kelas."}),e.jsx(m,{asChild:!0,className:"w-full max-w-md",children:e.jsx(K,{href:route("profile.edit",{redirect:window.location.href}),children:"Lengkapi Profil"})})]})})]})}export{$e as default};
